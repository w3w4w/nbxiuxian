{% extends "base.html" %}

{% block content %}
    <div class="card">
        <h2>{{ table_info.name }} æ•°æ®</h2>
        <p>{{ table_name }}</p>
        
        <div style="margin-bottom: 20px;">
            <a href="{{ url_for('database') }}" class="btn btn-info">
                <i class="fas fa-arrow-left"></i> è¿”å›
            </a>
        </div>
        
        <form class="search-form" method="get" action="{{ url_for('table_view', table_name=table_name) }}">
<select name="search_field" id="searchFieldSelect" onchange="handleSearchFieldChange()">
    <option value="">å…¨å­—æ®µæœç´¢</option>
    {% for field in table_info.fields %}
        <option value="{{ field }}" {% if search_field == field %}selected{% endif %}>{{ field }}</option>
    {% endfor %}
</select>

<select name="search_condition" id="searchConditionSelect" {% if search_field == '' %}disabled{% endif %}>
    <option value="=" {% if search_condition == '=' %}selected{% endif %}>=</option>
    <option value=">" {% if search_condition == '>' %}selected{% endif %}>&gt;</option>
    <option value="<" {% if search_condition == '<' %}selected{% endif %}>&lt;</option>
</select>

            <input type="text" name="search_value" placeholder="æœç´¢å†…å®¹ï¼ˆå¤šä¸ªå€¼ç”¨ç©ºæ ¼åˆ†éš”ï¼‰" value="{{ search_value or '' }}">
            <button type="submit" class="btn btn-info">æœç´¢</button>
            <a href="{{ url_for('table_view', table_name=table_name) }}" class="btn btn-info">é‡ç½®æœç´¢</a>
        </form>
        
        <!-- æ‰¹é‡æ“ä½œè¡¨å• -->
        <div class="card" style="margin-top: 20px; background-color: #f8f9fa;">
            <h3>æ‰¹é‡ä¿®æ”¹</h3>
<!-- æ‰¹é‡æ“ä½œè¡¨å• -->
<form id="batchForm" method="post" action="{{ url_for('batch_edit', table_name=table_name) }}">
    <input type="hidden" name="search_field" value="{{ search_field or '' }}">
    <input type="hidden" name="search_value" value="{{ search_value or '' }}">
    <input type="hidden" name="search_condition" value="{{ search_condition }}">  <!-- æ·»åŠ æœç´¢æ¡ä»¶ -->

    <div class="form-group">
        <label for="batch_field">é€‰æ‹©å­—æ®µ</label>
        <select id="batch_field" name="batch_field" required>
            <option value="">è¯·é€‰æ‹©è¦ä¿®æ”¹çš„å­—æ®µ</option>
            {% for field in table_info.fields %}
                {% if field != table_info.primary_key %}
                    <option value="{{ field }}" 
                            {% if search_field and search_field != '' and search_field == field %}selected{% endif %}>
                        {{ field }}
                    </option>
                {% endif %}
            {% endfor %}
        </select>
        <small id="batchFieldHelp" class="form-text text-muted">
            {% if search_field and search_field != '' %}
                å·²è‡ªåŠ¨é€‰æ‹©æœç´¢å­—æ®µ: <strong>{{ search_field }}</strong>
            {% else %}
                è¯·é€‰æ‹©è¦æ‰¹é‡ä¿®æ”¹çš„å­—æ®µ
            {% endif %}
        </small>
    </div>

    <!-- å…¶ä»–è¡¨å•å­—æ®µä¿æŒä¸å˜ -->
    <div class="form-group">
        <label for="operation">æ“ä½œç±»å‹</label>
        <select id="operation" name="operation" required>
            <option value="set">æ›¿æ¢ä¸º</option>
            <option value="add">å¢åŠ </option>
            <option value="subtract">å‡å°‘</option>
        </select>
    </div>

    <div class="form-group">
        <label for="value">å€¼</label>
        <input type="text" id="value" name="value" required>
    </div>

    <div class="form-group">
        <label>
            <input type="checkbox" id="apply_to_all" name="apply_to_all">
            åº”ç”¨åˆ°æ•´å¼ è¡¨ï¼ˆå¿½ç•¥æœç´¢æ¡ä»¶ï¼‰
        </label>
    </div>

    <button type="submit" class="btn btn-success">æ‰§è¡Œæ‰¹é‡æ“ä½œ</button>
    <span id="batchResult" style="margin-left: 15px;"></span>
</form>
</div>
        
        <div style="overflow-x: auto; margin-top: 20px;">
            <table>
                <thead>
                    <tr>
                        <th>æ“ä½œ</th>
                        {% for field in table_info.fields %}
                            <th>{{ field }}{% if field == primary_key %} ğŸ”‘{% endif %}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in data.data %}
                        <tr>
                            <td>
                                {% if table_name == "impart_cards" %}
                                    {# impart_cardsè¡¨ä½¿ç”¨å¤åˆä¸»é”® #}
                                    {% set composite_key = row['user_id'] ~ '_' ~ row['card_name'] %}
                                    <a href="{{ url_for('row_edit', table_name=table_name, row_id=composite_key) }}" class="btn btn-primary">ç¼–è¾‘</a>
                                {% elif table_name == "back" %}
                                    {# èƒŒåŒ…è¡¨ä½¿ç”¨å¤åˆä¸»é”® #}
                                    {% set composite_key = row['user_id'] ~ '_' ~ row['goods_id'] %}
                                    <a href="{{ url_for('row_edit', table_name=table_name, row_id=composite_key) }}" class="btn btn-primary">ç¼–è¾‘</a>
                                {% else %}
                                    {# å…¶ä»–è¡¨ä½¿ç”¨æ™®é€šä¸»é”® #}
                                    <a href="{{ url_for('row_edit', table_name=table_name, row_id=row[primary_key]) }}" class="btn btn-primary">ç¼–è¾‘</a>
                                {% endif %}
                            </td>
                            {% for field in table_info.fields %}
                                <td>
                                    {% if field in row %}
                                        {{ row[field] }}
                                    {% else %}
                                        NULL
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- åˆ†é¡µå¯¼èˆª -->
        <div class="pagination">
            {% set current_page = data.page %}
            {% set total_pages = data.total_pages %}
            
            {# ç¬¬ä¸€é¡µ #}
            {% if current_page > 1 %}
                <a href="{{ url_for('table_view', table_name=table_name, page=1, search_condition=search_condition, search_field=search_field, search_value=search_value) }}">1</a>
            {% endif %}
            
            {# å‰çœç•¥å· #}
            {% if current_page > 4 %}
                <span>...</span>
            {% endif %}
            
            {# å½“å‰é¡µçš„å‰3é¡µ #}
            {% for p in range([1, current_page-3]|max, current_page) %}
                {% if p > 1 %}
                    <a href="{{ url_for('table_view', table_name=table_name, page=p, search_condition=search_condition, search_field=search_field, search_value=search_value) }}">{{ p }}</a>
                {% endif %}
            {% endfor %}
            
            {# å½“å‰é¡µ #}
            <a href="{{ url_for('table_view', table_name=table_name, page=current_page, search_condition=search_condition, search_field=search_field, search_value=search_value) }}" class="active">{{ current_page }}</a>
            
            {# å½“å‰é¡µçš„å3é¡µ #}
            {% for p in range(current_page+1, [current_page+4, total_pages+1]|min) %}
                <a href="{{ url_for('table_view', table_name=table_name, page=p, search_condition=search_condition, search_field=search_field, search_value=search_value) }}">{{ p }}</a>
            {% endfor %}
            
            {# åçœç•¥å· #}
            {% if total_pages > current_page + 3 %}
                <span>...</span>
            {% endif %}
            
            {# æœ€åä¸€é¡µ #}
            {% if total_pages > 4 and current_page < total_pages -3 and current_page < total_pages %}
                <a href="{{ url_for('table_view', table_name=table_name, page=total_pages, search_condition=search_condition, search_field=search_field, search_value=search_value) }}">{{ total_pages }}</a>
            {% endif %}
        </div>
        
        <div style="margin-top: 10px;">
            æ˜¾ç¤º {{ (data.page - 1) * data.per_page + 1 }} - {{ [data.page * data.per_page, data.total]|min }} æ¡ï¼Œå…± {{ data.total }} æ¡
        </div>
    </div>

    <script>
        // æ‰¹é‡æ“ä½œè¡¨å•æäº¤
        document.getElementById('batchForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const applyToAll = document.getElementById('apply_to_all').checked;
            const batchField = document.getElementById('batch_field').value;
            const operation = document.getElementById('operation').value;
            const value = document.getElementById('value').value;
            
            let message = `ç¡®å®šè¦æ‰§è¡Œæ‰¹é‡æ“ä½œå—ï¼Ÿ\nå­—æ®µ: ${batchField}\næ“ä½œ: ${operation}\nå€¼: ${value}`;
            
            if (applyToAll) {
                message += "\n\nâš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†åº”ç”¨åˆ°æ•´å¼ è¡¨çš„æ‰€æœ‰è®°å½•ï¼";
            }
            
            if (!confirm(message)) {
                return;
            }
            
            const formData = new FormData(this);
            const resultSpan = document.getElementById('batchResult');
            resultSpan.innerHTML = '<span style="color: blue;">å¤„ç†ä¸­...</span>';
            
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultSpan.innerHTML = `<span style="color: green;">${data.message}</span>`;
                    // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ›´æ–°åçš„æ•°æ®
                    setTimeout(() => location.reload(), 1000);
                } else {
                    resultSpan.innerHTML = `<span style="color: red;">é”™è¯¯: ${data.error}</span>`;
                }
            })
            .catch(error => {
                resultSpan.innerHTML = `<span style="color: red;">è¯·æ±‚å¤±è´¥: ${error}</span>`;
            });
        });
        
        // å½“é€‰æ‹©åº”ç”¨åˆ°æ•´å¼ è¡¨æ—¶ï¼Œç¦ç”¨æœç´¢ç›¸å…³å­—æ®µ
        document.getElementById('apply_to_all')?.addEventListener('change', function() {
            const searchField = document.querySelector('input[name="search_field"]');
            const searchValue = document.querySelector('input[name="search_value"]');
            
            if (searchField && searchValue) {
                searchField.disabled = this.checked;
                searchValue.disabled = this.checked;
            }
        });

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ‰¹é‡ä¿®æ”¹å­—æ®µ
document.addEventListener('DOMContentLoaded', function() {
    const searchField = "{{ search_field or '' }}";
    const batchFieldSelect = document.getElementById('batch_field');
    const batchFieldHelp = document.getElementById('batchFieldHelp');
    
    // å¦‚æœæœ‰æœç´¢å­—æ®µä¸”ä¸æ˜¯å…¨å­—æ®µæœç´¢ï¼Œè‡ªåŠ¨é€‰æ‹©å¯¹åº”çš„æ‰¹é‡ä¿®æ”¹å­—æ®µ
    if (searchField && searchField !== '') {
        const option = batchFieldSelect.querySelector(`option[value="${searchField}"]`);
        if (option) {
            option.selected = true;
            batchFieldHelp.innerHTML = `å·²è‡ªåŠ¨é€‰æ‹©æœç´¢å­—æ®µ: <strong>${searchField}</strong>`;
        }
    }
    
    // å½“é€‰æ‹©"åº”ç”¨åˆ°æ•´å¼ è¡¨"æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦é€‰æ‹©æ‰¹é‡ä¿®æ”¹å­—æ®µ
    document.getElementById('apply_to_all')?.addEventListener('change', function() {
        if (this.checked && batchFieldSelect.value === '') {
            alert('è¯·å…ˆé€‰æ‹©è¦æ‰¹é‡ä¿®æ”¹çš„å­—æ®µ');
            this.checked = false;
        }
    });
    
    // è¡¨å•æäº¤å‰çš„éªŒè¯
    document.getElementById('batchForm')?.addEventListener('submit', function(e) {
        const applyToAll = document.getElementById('apply_to_all').checked;
        const batchField = document.getElementById('batch_field').value;
        const searchField = "{{ search_field or '' }}";
        
        // å¦‚æœæ˜¯å…¨å­—æ®µæœç´¢ä¸”æ²¡æœ‰é€‰æ‹©æ‰¹é‡ä¿®æ”¹å­—æ®µï¼Œé˜»æ­¢æäº¤
        if ((!searchField || searchField === '') && batchField === '') {
            e.preventDefault();
            alert('å…¨å­—æ®µæœç´¢æ—¶ï¼Œè¯·é€‰æ‹©è¦æ‰¹é‡ä¿®æ”¹çš„å­—æ®µ');
            return false;
        }
        
        // å¦‚æœåº”ç”¨åˆ°æ•´å¼ è¡¨ä½†æœªé€‰æ‹©æ‰¹é‡ä¿®æ”¹å­—æ®µï¼Œé˜»æ­¢æäº¤
        if (applyToAll && batchField === '') {
            e.preventDefault();
            alert('åº”ç”¨åˆ°æ•´å¼ è¡¨æ—¶ï¼Œè¯·é€‰æ‹©è¦æ‰¹é‡ä¿®æ”¹çš„å­—æ®µ');
            return false;
        }
    });
});

// æœç´¢å­—æ®µé€‰æ‹©å˜åŒ–æ—¶æ›´æ–°å¸®åŠ©æ–‡æœ¬
document.getElementById('searchFieldSelect')?.addEventListener('change', function() {
    const batchFieldSelect = document.getElementById('batch_field');
    const batchFieldHelp = document.getElementById('batchFieldHelp');
    
    if (this.value && this.value !== '') {
        // è‡ªåŠ¨é€‰æ‹©å¯¹åº”çš„æ‰¹é‡ä¿®æ”¹å­—æ®µ
        const option = batchFieldSelect.querySelector(`option[value="${this.value}"]`);
        if (option) {
            option.selected = true;
            batchFieldHelp.innerHTML = `å·²è‡ªåŠ¨é€‰æ‹©æœç´¢å­—æ®µ: <strong>${this.value}</strong>`;
        }
    } else {
        // å…¨å­—æ®µæœç´¢æ—¶é‡ç½®å¸®åŠ©æ–‡æœ¬
        batchFieldHelp.innerHTML = 'è¯·é€‰æ‹©è¦æ‰¹é‡ä¿®æ”¹çš„å­—æ®µ';
    }
});
function handleSearchFieldChange() {
    const searchFieldSelect = document.getElementById('searchFieldSelect');
    const searchConditionSelect = document.getElementById('searchConditionSelect');
    
    if (searchFieldSelect.value === '') {
        // å…¨å­—æ®µæœç´¢
        searchConditionSelect.value = '=';
        searchConditionSelect.disabled = true;
    } else {
        // å…¶ä»–å­—æ®µ
        searchConditionSelect.disabled = false;
    }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    handleSearchFieldChange(); // åˆå§‹åŒ–æœç´¢æ¡ä»¶é€‰æ‹©æ¡†çš„çŠ¶æ€
});
    </script>
{% endblock %}
