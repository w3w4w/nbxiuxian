{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>æ¬¢è¿, ç®¡ç†å‘˜ {{ admin_id }}</h2>
    
    <!-- ç»Ÿè®¡æ•°æ® -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(45deg, #4CAF50, #81C784);">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <h3 id="total-users">åŠ è½½ä¸­...</h3>
                <p>æ€»ç”¨æˆ·æ•°</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(45deg, #2196F3, #64B5F6);">
                <i class="fas fa-landmark"></i>
            </div>
            <div class="stat-content">
                <h3 id="total-sects">åŠ è½½ä¸­...</h3>
                <p>å®—é—¨æ•°é‡</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(45deg, #FF9800, #FFB74D);">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <h3 id="active-users">åŠ è½½ä¸­...</h3>
                <p>ä»Šæ—¥æ´»è·ƒç”¨æˆ·</p>
            </div>
        </div>
    </div>
    
    <!-- ç³»ç»Ÿç›‘æ§ -->
    <div class="card" style="margin-top: 20px;">
        <h3><i class="fas fa-chart-pie"></i> ç³»ç»Ÿç›‘æ§</h3>
        <div class="monitor-grid">
            <!-- CPUç›‘æ§ -->
            <div class="monitor-card">
                <h4><i class="fas fa-microchip"></i> CPUä½¿ç”¨ç‡</h4>
                <div class="monitor-content">
                    <div class="circular-progress" data-percent="0" data-color="#4CAF50">
                        <div class="progress-circle">
                            <svg viewBox="0 0 100 100">
                                <circle class="progress-bg" cx="50" cy="50" r="45"></circle>
                                <circle class="progress-fill" cx="50" cy="50" r="45" 
                                        style="stroke-dashoffset: 283;"></circle>
                            </svg>
                            <div class="progress-text">
                                <span id="cpu-percent">0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="cpu-history-chart" id="cpu-history">
                        <div class="chart-title">æœ€è¿‘5æ¬¡CPUå˜åŒ–</div>
                        <div class="chart-bars"></div>
                    </div>
                </div>
            </div>
            
            <!-- å†…å­˜ç›‘æ§ -->
            <div class="monitor-card">
                <h4><i class="fas fa-memory"></i> å†…å­˜ä½¿ç”¨</h4>
                <div class="monitor-content">
                    <div class="circular-progress" data-percent="0" data-color="#2196F3">
                        <div class="progress-circle">
                            <svg viewBox="0 0 100 100">
                                <circle class="progress-bg" cx="50" cy="50" r="45"></circle>
                                <circle class="progress-fill" cx="50" cy="50" r="45" 
                                        style="stroke-dashoffset: 283;"></circle>
                            </svg>
                            <div class="progress-text">
                                <span id="memory-percent">0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="process-list" id="memory-processes">
                        <div class="process-title">å†…å­˜å ç”¨å‰5è¿›ç¨‹</div>
                        <div class="process-items">
                            <div class="loading">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç£ç›˜ç›‘æ§ -->
            <div class="monitor-card">
                <h4><i class="fas fa-hdd"></i> ç£ç›˜ä½¿ç”¨</h4>
                <div class="monitor-content">
                    <div class="circular-progress" data-percent="0" data-color="#FF9800">
                        <div class="progress-circle">
                            <svg viewBox="0 0 100 100">
                                <circle class="progress-bg" cx="50" cy="50" r="45"></circle>
                                <circle class="progress-fill" cx="50" cy="50" r="45" 
                                        style="stroke-dashoffset: 283;"></circle>
                            </svg>
                            <div class="progress-text">
                                <span id="disk-percent">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å¿«æ·æ“ä½œ -->
    <div class="card" style="margin-top: 20px;">
        <h3><i class="fas fa-bolt"></i> å¿«æ·æ“ä½œ</h3>
        <div class="action-grid">
            <a href="{{ url_for('database') }}" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-database"></i>
                </div>
                <div class="action-content">
                    <h4>æ•°æ®åº“ç®¡ç†</h4>
                    <p>ç®¡ç†ç”¨æˆ·æ•°æ®</p>
                </div>
            </a>
            
            <a href="{{ url_for('commands') }}" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-terminal"></i>
                </div>
                <div class="action-content">
                    <h4>ç®¡ç†å‘˜æŒ‡ä»¤</h4>
                    <p>æ‰§è¡Œç®¡ç†å‘½ä»¤</p>
                </div>
            </a>
            
            <a href="{{ url_for('config_management') }}" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="action-content">
                    <h4>é…ç½®ç®¡ç†</h4>
                    <p>ä¿®æ”¹é…ç½®</p>
                </div>
            </a>

            <a href="{{ url_for('update') }}" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-sync-alt"></i>
                </div>
                <div class="action-content">
                    <h4>æ£€æµ‹æ›´æ–°</h4>
                    <p>æ’ä»¶æ›´æ–°</p>
                </div>
            </a>
        </div>
    </div>

    
    <!-- ç³»ç»Ÿä¿¡æ¯ -->
    <div class="card" style="margin-top: 20px;">
        <h3><i class="fas fa-server"></i> ç³»ç»Ÿä¿¡æ¯</h3>
        <div id="system-info" class="info-grid">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
</div>

<style>
/* åœ†å½¢è¿›åº¦æ¡æ ·å¼ */
.circular-progress {
    position: relative;
    width: 120px;
    height: 120px;
    margin: 0 auto 15px;
}

.progress-circle {
    width: 100%;
    height: 100%;
}

.progress-circle svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.progress-bg {
    fill: none;
    stroke: #f0f0f0;
    stroke-width: 8;
}

.progress-fill {
    fill: none;
    stroke-width: 8;
    stroke-linecap: round;
    transition: stroke-dashoffset 0.5s ease;
    stroke-dasharray: 283;
    stroke-dashoffset: 283;
}

.progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.progress-text span {
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
}

/* ç›‘æ§å¡ç‰‡å†…å®¹å¸ƒå±€ */
.monitor-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
}

/* CPUå†å²å›¾è¡¨æ ·å¼ */
.cpu-history-chart {
    width: 100%;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-top: 10px;
}

.chart-title {
    font-size: 0.8rem;
    font-weight: bold;
    margin-bottom: 8px;
    color: #666;
    text-align: center;
}

.chart-bars {
    display: flex;
    height: 50px;
    align-items: flex-end;
    gap: 6px;
    justify-content: space-between;
    padding: 0 5px;
}

.chart-bar {
    flex: 1;
    min-width: 30px;
    background: linear-gradient(to top, #4CAF50, #8BC34A);
    border-radius: 3px 3px 0 0;
    min-height: 5px;
    transition: height 0.3s ease;
    position: relative;
    max-width: 18%;
}

/* æŸ±å­ä¸Šçš„ç™¾åˆ†æ¯”æ ‡ç­¾ */
.chart-bar::after {
    content: attr(data-percent);
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    font-weight: bold;
    color: #333;
    white-space: nowrap;
    background: rgba(255, 255, 255, 0.9);
    padding: 2px 4px;
    border-radius: 3px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

/* ç©ºæŸ±å­æ ·å¼ - æ— æ•°æ®æ—¶æ˜¾ç¤º */
.chart-bar.empty {
    background: #e9ecef;
    height: 5px !important;
}

.chart-bar.empty::after {
    content: "";
    display: none;
}

/* è¿›ç¨‹åˆ—è¡¨æ ·å¼ */
.process-list {
    width: 100%;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-top: 10px;
}

.process-title {
    font-size: 0.8rem;
    font-weight: bold;
    margin-bottom: 8px;
    color: #666;
    text-align: center;
}

.process-items {
    max-height: 120px;
    overflow-y: auto;
}

.process-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    border-bottom: 1px solid #eee;
    font-size: 0.75rem;
}

.process-item:last-child {
    border-bottom: none;
}

.process-name {
    color: #333;
    flex: 2;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.process-memory {
    color: #666;
    flex: 1;
    text-align: right;
    font-weight: bold;
}

.process-time {
    color: #999;
    flex: 1;
    text-align: right;
    font-size: 0.7rem;
}

/* ç›‘æ§ç½‘æ ¼å¸ƒå±€ */
.monitor-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.monitor-card {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    height: fit-content;
    min-height: 300px;
}

.monitor-card h4 {
    margin: 0 0 15px 0;
    color: #2c3e50;
    font-size: 1.1rem;
    text-align: center;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 1024px) {
    .monitor-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
    }
}

@media (max-width: 768px) {
    .monitor-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .monitor-card {
        min-height: 280px;
        padding: 15px;
    }
    
    .circular-progress {
        width: 100px;
        height: 100px;
        margin-bottom: 12px;
    }
    
    .progress-text span {
        font-size: 1.2rem;
    }
    
    .chart-bars {
        height: 40px;
        gap: 4px;
    }
    
    .chart-bar {
        min-width: 25px;
    }
    
    .chart-bar::after {
        font-size: 9px;
        top: -18px;
        padding: 1px 3px;
    }
    
    .cpu-history-chart,
    .process-list {
        padding: 8px;
    }
    
    .process-item {
        font-size: 0.7rem;
        padding: 3px 0;
    }
    
    .process-items {
        max-height: 100px;
    }
}

@media (max-width: 480px) {
    .monitor-card {
        min-height: 260px;
        padding: 12px;
    }
    
    .circular-progress {
        width: 90px;
        height: 90px;
        margin-bottom: 10px;
    }
    
    .chart-bars {
        height: 35px;
    }
    
    .process-items {
        max-height: 90px;
    }
}
</style>

<script>
// è·å–ç»Ÿè®¡ä¿¡æ¯
async function loadStats() {
    try {
        const response = await fetch('/get_stats');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('total-users').textContent = data.total_users.toLocaleString();
            document.getElementById('total-sects').textContent = data.total_sects.toLocaleString();
            document.getElementById('active-users').textContent = data.active_users.toLocaleString();
        }
    } catch (error) {
        console.error('è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
    }
}

// æ›´æ–°åœ†å½¢è¿›åº¦æ¡
function updateCircularProgress(elementId, percent) {
    const progressElement = document.querySelector(`#${elementId}`).closest('.circular-progress');
    const fillElement = progressElement.querySelector('.progress-fill');
    const textElement = progressElement.querySelector('.progress-text span');
    const color = progressElement.dataset.color;
    
    // æ ¹æ®ç™¾åˆ†æ¯”è®¾ç½®é¢œè‰²ï¼ˆç™½>ç»¿>çº¢ï¼‰
    let strokeColor;
    if (percent < 30) {
        strokeColor = '#4CAF50'; // ç»¿è‰²
    } else if (percent < 70) {
        strokeColor = '#FF9800'; // æ©™è‰²
    } else {
        strokeColor = '#F44336'; // çº¢è‰²
    }
    
    // è®¡ç®—è¿›åº¦
    const circumference = 2 * Math.PI * 45;
    const offset = circumference - (percent / 100 * circumference);
    
    // æ›´æ–°è¿›åº¦
    fillElement.style.strokeDashoffset = offset;
    fillElement.style.stroke = strokeColor;
    textElement.textContent = `${percent}%`;
}

// CPUå†å²æ•°æ®
let cpuHistoryData = [];

// æ›´æ–°CPUå†å²å›¾è¡¨
function updateCpuHistoryChart() {
    const chartBars = document.querySelector('.chart-bars');
    chartBars.innerHTML = '';
    
    // ç¡®ä¿æœ‰5ä¸ªæŸ±å­
    const displayData = [...cpuHistoryData];
    
    for (let i = 0; i < 5; i++) {
        const value = displayData[i] || 0; // å¦‚æœæ²¡æœ‰æ•°æ®åˆ™ä¸º0
        const bar = document.createElement('div');
        bar.className = 'chart-bar';
        
        if (value === 0) {
            bar.classList.add('empty'); // æ·»åŠ ç©ºæŸ±å­æ ·å¼
            bar.style.height = '5px'; // æœ€å°é«˜åº¦
        } else {
            bar.style.height = `${value}%`;
            bar.setAttribute('data-percent', `${Math.round(value)}%`);
        }
        
        bar.title = value === 0 ? 'æ— æ•°æ®' : `${Math.round(value)}%`;
        chartBars.appendChild(bar);
    }
}

// è·å–ç³»ç»Ÿç›‘æ§ä¿¡æ¯
async function loadSystemMonitor() {
    try {
        const response = await fetch('/get_system_info_extended');
        const data = await response.json();
        
        if (data.success) {
            // æ›´æ–°CPU
            const cpuUsage = parseFloat(data.cpu_info['CPUä½¿ç”¨ç‡'].replace('%', ''));
            updateCircularProgress('cpu-percent', cpuUsage);
            
            // æ›´æ–°CPUå†å²æ•°æ®ï¼ˆä¿ç•™æœ€è¿‘5æ¬¡ï¼‰
            // åªæœ‰å½“æœ‰å®é™…æ•°æ®æ—¶æ‰æ·»åŠ åˆ°å†å²è®°å½•
            if (!isNaN(cpuUsage) && cpuUsage > 0) {
                cpuHistoryData.push(cpuUsage);
            }
            
            if (cpuHistoryData.length > 5) {
                cpuHistoryData.shift(); // ç§»é™¤æœ€æ—§çš„æ•°æ®
            }
            updateCpuHistoryChart();
            
            // æ›´æ–°å†…å­˜
            const memoryUsage = parseFloat(data.mem_info['å†…å­˜ä½¿ç”¨ç‡'].replace('%', ''));
            updateCircularProgress('memory-percent', memoryUsage);
            
            // æ›´æ–°ç£ç›˜
            const diskUsage = parseFloat(data.disk_info['ç£ç›˜ä½¿ç”¨ç‡'].replace('%', ''));
            updateCircularProgress('disk-percent', diskUsage);
        }
    } catch (error) {
        console.error('è·å–ç³»ç»Ÿç›‘æ§ä¿¡æ¯å¤±è´¥:', error);
    }
}

// è·å–è¿›ç¨‹ä¿¡æ¯
async function getProcessInfo() {
    try {
        const response = await fetch('/get_process_info');
        const data = await response.json();
        
        if (data.success) {
            const processContainer = document.querySelector('.process-items');
            processContainer.innerHTML = '';
            
            data.processes.forEach(process => {
                const item = document.createElement('div');
                item.className = 'process-item';
                item.innerHTML = `
                    <div class="process-name" title="${process.name}">${process.name}</div>
                    <div class="process-memory">${process.memory}</div>
                    <div class="process-time">${process.time}</div>
                `;
                processContainer.appendChild(item);
            });
        }
    } catch (error) {
        console.error('è·å–è¿›ç¨‹ä¿¡æ¯å¤±è´¥:', error);
    }
}

// è·å–ç³»ç»Ÿä¿¡æ¯
async function loadSystemInfo() {
    try {
        const response = await fetch('/get_system_info_extended');
        const data = await response.json();
        
        if (data.success) {
            const systemInfoDiv = document.getElementById('system-info');
            let html = '';
            
            // ç³»ç»ŸåŸºæœ¬ä¿¡æ¯
            html += '<div class="info-item">';
            html += '<h4>ğŸ’» ç³»ç»Ÿä¿¡æ¯</h4>';
            for (const [key, value] of Object.entries(data.system_info)) {
                html += `<p><strong>${key}:</strong> ${value}</p>`;
            }
            html += '</div>';
            
            // CPUä¿¡æ¯
            html += '<div class="info-item">';
            html += '<h4>âš¡ CPUä¿¡æ¯</h4>';
            for (const [key, value] of Object.entries(data.cpu_info)) {
                html += `<p><strong>${key}:</strong> ${value}</p>`;
            }
            html += '</div>';
            
            // å†…å­˜ä¿¡æ¯
            html += '<div class="info-item">';
            html += '<h4>ğŸ§  å†…å­˜ä¿¡æ¯</h4>';
            for (const [key, value] of Object.entries(data.mem_info)) {
                html += `<p><strong>${key}:</strong> ${value}</p>`;
            }
            html += '</div>';
            
            // ç£ç›˜ä¿¡æ¯
            html += '<div class="info-item">';
            html += '<h4>ğŸ’¾ ç£ç›˜ä¿¡æ¯</h4>';
            for (const [key, value] of Object.entries(data.disk_info)) {
                html += `<p><strong>${key}:</strong> ${value}</p>`;
            }
            html += '</div>';
            
            // ç³»ç»Ÿè¿è¡Œæ—¶é—´
            html += '<div class="info-item">';
            html += '<h4>â±ï¸ ç³»ç»Ÿè¿è¡Œæ—¶é—´</h4>';
            for (const [key, value] of Object.entries(data.system_uptime)) {
                html += `<p><strong>${key}:</strong> ${value}</p>`;
            }
            html += '</div>';
            
            systemInfoDiv.innerHTML = html;
        }
    } catch (error) {
        console.error('è·å–ç³»ç»Ÿä¿¡æ¯å¤±è´¥:', error);
    }
}

// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–ç©ºçš„å†å²æ•°æ®
    cpuHistoryData = [];
    updateCpuHistoryChart(); // å…ˆæ˜¾ç¤ºç©ºå›¾è¡¨
    
    loadStats();
    loadSystemMonitor();
    loadSystemInfo();
    getProcessInfo();
    
    // å®šæ—¶åˆ·æ–°
    setInterval(loadStats, 10000);
    setInterval(loadSystemMonitor, 2000);
    setInterval(getProcessInfo, 5000);
    setInterval(loadSystemInfo, 10000);
});
</script>
{% endblock %}
